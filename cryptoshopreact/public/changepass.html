<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
   <title>Login</title>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>
   <form action="/login" method="POST">
      <label for="username">Username: </label>
      <input type="text" name="username" id="username" />
      <label for="password">New Password: </label>
      <input type="password" name="password" id="password" />
      <input type="submit" value="Submit" />
   </form>
</body>

<script type="text/javascript">
	const form = document.querySelector("form");
	
	form.addEventListener("submit", function(evt) {
		console.log("here");
		console.log(this);
		evt.preventDefault();
		const userdat = {
			username: this.username.value,
			password: this.password.value
		};

		const url = "/user/resetPass" + location.search;
		
		$.ajax({
			method: "PUT",
			data: userdat,
			url: url
		}).then((response) => {
			console.log(response);
			tokenSession(response.token).then(getMainPage);
		}).catch(console.log.bind(console));	

	});

	function tokenSession(token) {
		sessionStorage.setItem("token", token);
		return Promise.resolve(token);
	}

	function getMainPage(token) {
		
		$.ajax({
			method: "GET",
			url: "/user"
		}).then((res) => {
			console.log("authorized");
			location.assign("/user");
		}).catch(console.log.bind(console));
	}
</script>

</html>